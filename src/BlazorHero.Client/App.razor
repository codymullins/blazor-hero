@inject GameEngine Engine
@inject GameState State
@inject InputService Input
@inject DeviceService Device

<div class="game-app" @ref="_appElement" tabindex="0">
    @switch (State.Current)
    {
        case GameStateType.Loading:
            <LoadingScreen />
            break;
        case GameStateType.MainMenu:
            <MainMenu OnPlay="GoToSongSelect" />
            break;
        case GameStateType.SongSelect:
            <SongSelect 
                OnSongSelected="OnSongSelected" 
                OnBack="GoToMainMenu"
                @ref="_songSelect" />
            break;
        case GameStateType.Countdown:
        case GameStateType.Playing:
        case GameStateType.Paused:
            <GameScreen />
            break;
        case GameStateType.Results:
            <ResultsScreen
                Stats="@Engine.LastStats"
                SongMeta="@Engine.CurrentSongMeta"
                OnRestart="RestartSong"
                OnBack="GoToSongSelect" />
            break;
    }
</div>

@code {
    private ElementReference _appElement;
    private SongSelect? _songSelect;

    protected override void OnInitialized()
    {
        Engine.StateChanged += OnStateChanged;
        State.StateChanged += OnGameStateChanged;
        Input.SpecialKeyPressed += OnSpecialKeyPressed;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        Console.WriteLine($"[App.OnAfterRenderAsync] firstRender={firstRender}, state={State.Current}");
        if (firstRender)
        {
            // Initialize device detection first (needed for mobile layout decisions)
            Console.WriteLine("[App.OnAfterRenderAsync] Calling Device.InitializeAsync");
            await Device.InitializeAsync();
            Console.WriteLine($"[App.OnAfterRenderAsync] Device initialized: mobile={Device.IsMobile}, touch={Device.HasTouch}");

            // Initialize JS modules early (before any game screen needs them)
            Console.WriteLine("[App.OnAfterRenderAsync] Calling InitializeModulesAsync");
            await Engine.InitializeModulesAsync();
            Console.WriteLine("[App.OnAfterRenderAsync] InitializeModulesAsync completed");
        }
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnGameStateChanged(GameStateType from, GameStateType to)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnSpecialKeyPressed(string key)
    {
        Console.WriteLine($"[App] OnSpecialKeyPressed: {key}, State: {State.Current}");
        InvokeAsync(async () =>
        {
            switch (State.Current)
            {
                case GameStateType.MainMenu:
                    if (key == "confirm")
                    {
                        Console.WriteLine("[App] MainMenu: confirm -> GoToSongSelect");
                        GoToSongSelect();
                    }
                    break;

                case GameStateType.SongSelect:
                    if (key == "escape" || key == "back")
                    {
                        GoToMainMenu();
                    }
                    else if (_songSelect != null)
                    {
                        Console.WriteLine($"[App] SongSelect: Handling key {key}");
                        await _songSelect.HandleKeyAsync(key);
                    }
                    else
                    {
                        Console.WriteLine($"[App] SongSelect: _songSelect is NULL!");
                    }
                    break;

                case GameStateType.Results:
                    if (key == "restart")
                    {
                        await RestartSong();
                    }
                    else if (key == "escape" || key == "back")
                    {
                        GoToSongSelect();
                    }
                    break;
            }
            StateHasChanged();
        });
    }

    private void GoToMainMenu()
    {
        Engine.GoToMainMenu();
    }

    private void GoToSongSelect()
    {
        Engine.GoToSongSelect();
    }

    private async Task OnSongSelected((string ChartFile, Difficulty Difficulty) selection)
    {
        await Engine.StartSongAsync(selection.ChartFile, selection.Difficulty);
    }

    private async Task RestartSong()
    {
        await Engine.RestartSong();
    }

    public void Dispose()
    {
        Engine.StateChanged -= OnStateChanged;
        State.StateChanged -= OnGameStateChanged;
        Input.SpecialKeyPressed -= OnSpecialKeyPressed;
    }
}
